import{html as s,render as l}from"./lit-html.js";import{unsafeHTML as h}from"./unsafe-html.js";import a from"./env.js";import{parseDataset as c}from"./general.js";import u from"./progress-indicator.js";import m from"./component.js";a.css(["button","download-button"]);class r extends m{constructor(){super();this.handleClick=t=>{this.fetchData()};this.handleKeydown=t=>{t instanceof KeyboardEvent&&t.key.toLowerCase()===" "&&this.classList.add("is-active")};this.handleKeyup=t=>{t instanceof KeyboardEvent&&t.key.toLowerCase()===" "&&(this.classList.remove("is-active"),this.fetchData())};this.downloading=!1,this.model={label:"",downloadingLabel:"downloading",kind:"solid",color:"primary",shape:"default",size:"default",icon:"",url:location.origin,options:{method:"GET"},workerURL:"/js/file-download-worker.js"}}static get observedAttributes(){return["data-label","data-icon","data-kind","data-color","data-shape","data-size","data-url","data-options","data-worker-url","data-downloading-label"]}async connected(){const t=c(this.dataset,this.model);this.set(t),this.addEventListener("click",this.handleClick),this.addEventListener("keydown",this.handleKeydown),this.addEventListener("keyup",this.handleKeyup)}async fetchData(){if(this.downloading)return;this.downloading=!0;const t=this.querySelector("svg, img");t&&(t.style.display="none");const e=this.querySelector("span");e&&(e.innerText=this.model.downloadingLabel);const o=new Worker(this.model.workerURL);o.onmessage=d=>{const{type:n,data:i}=d.data;switch(n){case"tick":this.indicator.tick(i);break;case"start":this.indicator=new u({total:i,class:"mr-0.5",css:"margin-left:-0.25rem;",color:"grey"}),this.insertBefore(this.indicator,this.childNodes[0]);break;case"done":this.dispatchEvent(new CustomEvent("download",{detail:{blob:new Blob([i])}})),this.indicator.remove(),e.innerText=this.model.label,t&&(t.style.display="inline-block"),o.terminate(),this.downloading=!1;break;case"error":this.dispatchEvent(new CustomEvent("error",{detail:{error:i}})),o.terminate(),this.indicator.remove(),e.innerText=this.model.label,t&&(t.style.display="inline-block"),this.downloading=!1;break;default:console.warn(`Unhandled file download worker message type: ${n}`);break}},o.postMessage({url:this.model.url,options:this.model.options})}renderIcon(){let t;return this.model.icon.length?t=s`${h(this.model.icon)}`:t="",t}render(){const t=s` ${this.renderIcon()} <span>${this.model.label}</span> `;this.classList.add("bttn"),this.setAttribute("role","button"),this.tabIndex=0,this.setAttribute("color",this.model.color),this.setAttribute("size",this.model.size),this.setAttribute("kind",this.model.kind),this.setAttribute("shape",this.model.shape),this.model.icon?.length&&this.setAttribute("icon","left"),this.setAttribute("sfx","button"),l(t,this)}}a.bind("download-button-component",r);export{r as default};
